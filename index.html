<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zama score calculator</title>
<style>
  :root{
    --bg:#0b0b0b; --card:#151515; --fg:#f7f7f7; --muted:#c8c8c8; --accent:#f4c20d; --accent2:#ffda3a;
    --bad:#ff5a5a; --warn:#ffb84d; --good:#6ad36a; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
  html,body{background:var(--bg); color:var(--fg); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0}
  .wrap{max-width:none; width:100%; margin:0 auto; padding:16px}
  header{display:flex; gap:14px; align-items:center; margin-bottom:8px}
  header img{width:auto; height:42px; padding-right: 50px}
  h1{font-size:1.9rem; margin:0}
  .muted{color:var(--muted)}
  .card{background:linear-gradient(180deg, rgba(244,194,13,.12), rgba(244,194,13,.05)); border:1px solid rgba(244,194,13,.25); border-radius:16px; padding:16px; margin:14px 0; box-shadow: 0 0 0 1px rgba(244,194,13,.08) inset}
  .grid{display:grid; gap:12px}
  .two{grid-template-columns: 1fr 1fr}
  @media(max-width:900px){.two{grid-template-columns:1fr}}
  .row{display:grid; grid-template-columns: 190px 1fr; gap:10px; align-items:center; margin:8px 0}
  label{color:#ffe27a}
  input, select{background:#0f0f0f; color:var(--fg); border:1px solid rgba(244,194,13,.35); padding:10px 12px; border-radius:10px; outline:none}
  input:focus{box-shadow:0 0 0 2px rgba(255,218,58,.35)}
  .btn{background:#1a1a1a; border:1px solid rgba(244,194,13,.6); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn.primary{background:var(--accent2); color:#000; font-weight:700}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .right{display:flex; gap:8px; align-items:center}
  .lang{display:flex; gap:6px}
  .lang button{background:transparent; border:1px solid rgba(244,194,13,.4); color:var(--fg); padding:6px 10px; border-radius:10px; cursor:pointer}
  .lang button.active{background:var(--accent2); color:#000; border-color:var(--accent2)}
  table{width:100%; border-collapse:collapse; font-size:.95rem; table-layout:fixed}
  th,td{border-bottom:1px dashed rgba(244,194,13,.25); padding:8px 6px; text-align:left; vertical-align:middle}
  th{color:#ffe27a; position:sticky; top:0; background:rgba(15,15,15,.8); backdrop-filter: blur(6px)}
  #linksTable th:nth-child(1), #linksTable td:nth-child(1){width:36%}
  #linksTable th:nth-child(2), #linksTable td:nth-child(2){width:10%}
  #linksTable th:nth-child(3), #linksTable td:nth-child(3){width:9%}
  #linksTable th:nth-child(4), #linksTable td:nth-child(4){width:9%}
  #linksTable th:nth-child(5), #linksTable td:nth-child(5){width:9%}
  #linksTable th:nth-child(6), #linksTable td:nth-child(6){width:8%}
  #linksTable th:nth-child(7), #linksTable td:nth-child(7){width:8%}
  #linksTable th:nth-child(8), #linksTable td:nth-child(8){width:7%}
  #linksTable th:nth-child(9), #linksTable td:nth-child(9){width:4%}
  .mono{font-family:var(--mono)}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:.8rem; border:1px solid rgba(255,255,255,.1)}
  .pill.good{background:rgba(106,211,106,.12); border-color:rgba(106,211,106,.4)}
  .pill.warn{background:rgba(255,184,77,.12); border-color:rgba(255,184,77,.4)}
  .pill.bad{background:rgba(255,90,90,.12); border-color:rgba(255,90,90,.45)}
  footer{margin:20px 0; color:var(--muted); font-size:.9rem}
  .note{font-size:.9rem}
  a.link{color:var(--accent); text-decoration:none}
  a.link:hover{text-decoration:underline}
  .table-wrap{overflow:auto; max-height:calc(100vh - 420px); border:1px solid rgba(244,194,13,.25); border-radius:10px}
  @media(max-width:900px){ .table-wrap{max-height:unset} }
  .hide{display:none !important}
  .gates{width:auto; border-collapse:separate; border-spacing:0; margin-top:8px}
  .gates th,.gates td{border:1px solid rgba(244,194,13,.35); padding:6px 10px; white-space:nowrap}
  .gates th{background:rgba(244,194,13,.08); color:#ffe27a; position:static}

  /* sửa input trong bảng cho đỡ dính viền */
  #linksTable input,
  #linksTable select{
    width:100%;
    box-sizing:border-box;
    display:block;
    min-height:34px;
    line-height:1.2;
  }
  #linksTable td{padding:10px 8px}
  #linksTable input[type=number]::-webkit-outer-spin-button,
  #linksTable input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
  #linksTable input[type=number]{ -moz-appearance:textfield }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://github.com/doanlonghau/zama-calculator/blob/main/Zama_idDz0xiVMe_0.png?raw=true" alt="Zama logo" />
      <div>
        <h1 id="title">Zama creator program score calculator</h1>
        <div id="subtitle" class="muted">Enter global metrics, add post URLs, review per post and total scores</div>
      </div>
      <div class="right" style="margin-left:auto">
        <div class="lang" role="tablist" aria-label="Language">
          <button id="btnEN" class="active" role="tab" aria-selected="true">English</button>
          <button id="btnVI" role="tab" aria-selected="false">Tiếng Việt</button>
        </div>
      </div>
    </header>

    <div class="muted" id="introText">
      Tool by Long Hậu. Data is for reference. Follow
      <a class="link" href="https://x.com/doanlonghau" target="_blank" rel="noopener">@doanlonghau</a>
      ·
      <a class="link" href="https://x.com/cryptoluaga" target="_blank" rel="noopener">@cryptoluaga</a>
    </div>

    <section class="card">
      <div class="grid two">
        <div>
          <div style="display:flex; gap:10px; align-items:center">
            <div><span id="statPostsVal" class="mono" style="font-size:1.5rem">0</span> <span id="statPostsLabel" class="muted">posts</span></div>
            <div><span id="totalScore" class="mono" style="font-size:1.5rem">0</span> <span id="statTotalLabel" class="muted">total score</span></div>
          </div>
        </div>
        <div style="text-align:right">
          <div><span id="rankVsSS2" class="mono" style="font-size:1.5rem">>500</span> <span id="statRankLabel" class="muted">rank vs season 2</span></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 id="globalsHeader">Global parameters</h2>
      <div class="grid two">
        <div>
          <div class="row"><label id="lblFollowers" for="followers">followers</label><input id="followers" type="number" min="0" value="0" /></div>
          <div class="row"><label id="lblSmartFollowers" for="smartFollowers">smart followers</label><input id="smartFollowers" type="number" min="0" value="0" /></div>
          <div class="row"><label id="lblPosts" for="posts">number of posts</label><input id="posts" type="number" min="0" value="0" /></div>
        </div>
        <div>
          <div class="row"><label id="lblDerived">derived metrics</label>
            <div>
              <div class="muted note">SRM uses per row impressions. SF uses smart followers</div>
              <div class="note">SF <span class="mono" id="sfVal">0.00</span> · post mult <span class="mono" id="postMultVal">1.00</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 id="linksHeader">Posts</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:6px 0">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="addRow">Add row</button>
          <button class="btn" id="calcAll">Recalculate</button>
          <button class="btn" id="clearAll">Clear</button>
        </div>
        <div class="muted">sum <span id="sumScore" class="mono">0</span> · <span id="sumLabel">eligible total</span></div>
      </div>
      <div class="table-wrap">
        <table id="linksTable" aria-label="Post table"><thead></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card" id="connectX">
      <h2 id="xHeader">Connect X and import posts</h2>
      <div id="xDesc" class="muted">Mention @zama_fhe or use #ZamaCreatorProgram</div>

      <div class="grid two">
        <div>
          <div style="display:flex; gap:8px; align-items:center; margin:8px 0">
            <button id="xLoginBtn" class="btn primary">Sign in with X</button>
            <button id="xLogoutBtn" class="btn" style="display:none">Sign out</button>
            <span id="xAuthStatus" class="muted">Not connected</span>
          </div>
          <div class="row hide">
            <label id="xEstimateLabel" for="xEstimate">hidden</label>
            <input id="xEstimate" type="number" min="0.1" max="20" step="0.1" value="2.5" />
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0">
            <button id="xFetchBtn" class="btn" disabled>Fetch latest</button>
            <button id="xMoreBtn" class="btn" disabled>Load more</button>
          </div>
          <div class="muted hide" id="xApiHint">hidden</div>
        </div>
        <div class="hide">
          <div class="muted" style="margin-bottom:6px" id="xScopeTitle">hidden</div>
          <ul id="xScopeList" class="muted" style="margin:0 0 8px 18px"></ul>
          <div class="muted" id="xApiStatus">hidden</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 id="tipsHeader">Improvement tips</h2>
      <div id="tipsBox" class="muted"></div>
    </section>

    <section class="card">
      <h2 id="ss2Header">Season 2 comparison</h2>
      <div id="ss2Desc" class="muted" style="margin-bottom:6px">Estimated rank against top 100 200 300 500</div>
      <div id="ss2stats" class="note"></div>
      <table class="gates" aria-label="S2 gates">
        <tr><th>Top 100</th><td class="mono">11,260</td></tr>
        <tr><th>Top 200</th><td class="mono">7,013</td></tr>
        <tr><th>Top 300</th><td class="mono">4,761</td></tr>
        <tr><th>Top 500</th><td class="mono">2,897</td></tr>
      </table>
    </section>

    <footer class="muted" id="footerText">No data is transmitted</footer>
  </div>

<script>
  const $ = sel => document.querySelector(sel);

  const I18N = {
    en:{
      intro:"Tool by Long Hậu. Data is for reference. Follow <a href=https://x.com/doanlonghau target=_blank class=link rel=noopener>@doanlonghau</a> · <a href=https://x.com/cryptoluaga target=_blank class=link rel=noopener>@cryptoluaga</a>",
      title:"Zama creator program score calculator",
      subtitle:"Enter global metrics, add post URLs, review per post and total scores",
      statPosts:"posts", statTotal:"total score", statRank:"rank vs season 2",
      globalsHeader:"Global parameters", followers:"followers", smartFollowers:"smart followers", posts:"number of posts", derived:"derived metrics",
      linksHeader:"Posts", addLink:"Add row", calcAll:"Recalculate", clearAll:"Clear",
      th:["URL","Impr","Likes","RT","Quotes","ER percent","SRM","Score","Status",""], sumLabel:"eligible total",
      xHeader:"Connect X and import posts", xDesc:"Pull posts that mention @zama_fhe or #ZamaCreatorProgram. Client side only",
      xSignIn:"Sign in with X", xSignOut:"Sign out", xAuthReady:"Not connected", xAuthBusy:"Opening X login…", xAuthOk:h=>`Connected ${h}`, xAuthFail:"Login failed",
      tipsHeader:"Improvement tips",
      tips:{
        postMore:"Post up to 20 to gain the post multiplier",
        raiseImpr:"Aim near 100000 impressions per post to improve SRM",
        avoidPenalty:"If ER percent is above 10 and impressions are below 50000 then increase reach to avoid the 0.30 penalty",
        lowerERspikes:"Avoid abnormal ER spikes",
        improveER:"Average ER percent is low. Improve hooks CTA visuals timing",
        balanceMix:"Likes dominate. Encourage retweets and quotes because they weigh more",
        growQE:"Impressions per follower are low. Reach beyond followers to improve QE",
        dqWarn:"Some posts are disqualified due to observed ER above 20. Recheck data"
      },
      ss2Header:"Season 2 comparison", ss2Desc:"Estimated rank for top 100 200 300 500", youScore:"your score", gates:"gates", top:n=>`Top ${n}`,
      statusOK:"Eligible", statusDQ:"Disqualified observed ER above 20 percent", statusPenalty:"Penalty 0.30", statusIneligible:"Ineligible", footer:"No data is transmitted"
    },
    vi:{
      intro:"Công cụ do Long Hậu thực hiện. Dữ liệu chỉ tham khảo. Follow <a href=https://x.com/doanlonghau target=_blank class=link rel=noopener>@doanlonghau</a> · <a href=https://x.com/cryptoluaga target=_blank class=link rel=noopener>@cryptoluaga</a>",
      title:"Bộ tính điểm Zama",
      subtitle:"Nhập số liệu chung, dán link bài, xem điểm từng bài và tổng",
      statPosts:"bài", statTotal:"tổng điểm", statRank:"xếp hạng so với season 2",
      globalsHeader:"Thông số chung", followers:"follower", smartFollowers:"follower chất lượng", posts:"số bài", derived:"chỉ số tính thêm",
      linksHeader:"Bài viết", addLink:"Thêm dòng", calcAll:"Tính lại", clearAll:"Xóa",
      th:["URL","Impr","Like","RT","Quote","ER phần trăm","SRM","Điểm","Trạng thái",""], sumLabel:"tổng đủ điều kiện",
      xHeader:"Kết nối X và nhập bài", xDesc:"Lọc bài có @zama_fhe hoặc #ZamaCreatorProgram. Chạy trên trình duyệt",
      xSignIn:"Đăng nhập X", xSignOut:"Đăng xuất", xAuthReady:"Chưa kết nối", xAuthBusy:"Đang mở đăng nhập X…", xAuthOk:h=>`Đã kết nối ${h}`, xAuthFail:"Đăng nhập lỗi",
      tipsHeader:"Gợi ý cải thiện",
      tips:{
        postMore:"Đăng tối đa 20 bài để hưởng hệ số bài",
        raiseImpr:"Cố gắng gần 100000 impressions mỗi bài để tăng SRM",
        avoidPenalty:"Nếu ER trên 10 và impressions dưới 50000 thì tăng reach để tránh phạt 0.30",
        lowerERspikes:"Tránh ER tăng đột biến",
        improveER:"ER trung bình thấp. Cải thiện hook CTA hình ảnh và giờ đăng",
        balanceMix:"Like đang chiếm nhiều. Khuyến khích retweet và quote vì trọng số cao",
        growQE:"Impressions trên mỗi follower thấp. Mở rộng reach ngoài tệp follower",
        dqWarn:"Có bài bị loại vì ER quan sát trên 20. Kiểm tra lại"
      },
      ss2Header:"So với season 2", ss2Desc:"Ước lượng hạng ở mốc top 100 200 300 500", youScore:"điểm của bạn", gates:"ngưỡng", top:n=>`Top ${n}`,
      statusOK:"Đủ điều kiện", statusDQ:"Loại vì ER quan sát trên 20 phần trăm", statusPenalty:"Phạt 0.30", statusIneligible:"Không đủ điều kiện", footer:"Không gửi dữ liệu ra ngoài"
    }
  };
  let LANG = 'en';

  const SS2 = { n:500, p100:11260, p200:7013, p300:4761, p500:2897 };

  function fmt(x, d=0){ if(!isFinite(x)) return '0'; return (+x).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d}); }

  function renderStatic(){
    const t = I18N[LANG];
    $('#introText').innerHTML = t.intro;
    $('#title').textContent = t.title; $('#subtitle').textContent = t.subtitle;
    $('#statPostsLabel').textContent = t.statPosts; $('#statTotalLabel').textContent = t.statTotal; $('#statRankLabel').textContent = t.statRank;
    $('#globalsHeader').textContent = t.globalsHeader; $('#lblFollowers').textContent = t.followers; $('#lblSmartFollowers').textContent = t.smartFollowers; $('#lblPosts').textContent = t.posts; $('#lblDerived').textContent = t.derived;
    $('#linksHeader').textContent = t.linksHeader; $('#addRow').textContent = t.addLink; $('#calcAll').textContent = t.calcAll; $('#clearAll').textContent = t.clearAll; $('#sumLabel').textContent = t.sumLabel;
    $('#xHeader').textContent = t.xHeader; $('#xDesc').textContent = t.xDesc;
    $('#xLoginBtn').textContent = t.xSignIn; $('#xLogoutBtn').textContent = t.xSignOut; $('#xAuthStatus').textContent = t.xAuthReady;
    document.documentElement.lang = LANG === 'vi' ? 'vi' : 'en';
    $('#btnEN').classList.toggle('active', LANG==='en'); $('#btnVI').classList.toggle('active', LANG==='vi');
    $('#btnEN').setAttribute('aria-selected', LANG==='en' ? 'true' : 'false');
    $('#btnVI').setAttribute('aria-selected', LANG==='vi' ? 'true' : 'false');
  }

  $('#btnEN').addEventListener('click', ()=>{ LANG='en'; renderStatic(); buildThead(); recalc(); });
  $('#btnVI').addEventListener('click', ()=>{ LANG='vi'; renderStatic(); buildThead(); recalc(); });

  function buildThead(){
    const t = I18N[LANG];
    const tr = document.createElement('tr');
    t.th.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr.appendChild(th); });
    const thead = $('#linksTable thead'); thead.innerHTML=''; thead.appendChild(tr);
  }

  function globals(){
    const followers = +$('#followers').value||0; const smart_followers = +$('#smartFollowers').value||0; const posts = +$('#posts').value||0;
    const SF = Math.min(Math.log10(smart_followers + 1), 3.0);
    const postMult = 1 + 0.02 * Math.min(posts, 20);
    $('#sfVal').textContent = SF.toFixed(2); $('#postMultVal').textContent = postMult.toFixed(2);
    return { followers, smart_followers, posts, SF, postMult };
  }

  function addRow(obj){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input name=url placeholder=https://x.com/... style="width:100%" aria-label="post url" /></td>
      <td><input name=impressions type=number min=0 value=${obj?.impressions||0} aria-label="impressions"></td>
      <td><input name=likes type=number min=0 value=${obj?.likes||0} aria-label="likes"></td>
      <td><input name=retweets type=number min=0 value=${obj?.retweets||0} aria-label="retweets"></td>
      <td><input name=quotes type=number min=0 value=${obj?.quotes||0} aria-label="quotes"></td>
      <td class=mono data-erpct>0.00</td>
      <td class=mono data-srm>0.000</td>
      <td class=mono data-score>0</td>
      <td><span class="pill" data-status>Eligible</span></td>
      <td><button class="btn" data-del aria-label="delete row">X</button></td>`;
    $('#linksTable tbody').appendChild(tr);
    tr.querySelector('[data-del]').addEventListener('click', ()=>{ tr.remove(); recalc(); });
    tr.querySelectorAll('input').forEach(inp=> inp.addEventListener('input', recalc));
    return tr;
  }

  function computeRow(row, g){
    const read = n => +row.querySelector(`[name=${n}]`).value || 0;
    const impressions = Math.max(0, read('impressions'));
    const likes = Math.max(0, read('likes'));
    const rts = Math.max(0, read('retweets'));
    const quotes = Math.max(0, read('quotes'));
    const sengIn = 0;

    const SRM = Math.min(1, impressions/100000);
    const qW = 4 + 2*SRM;
    const ENG = likes + 3*rts + qW*quotes;
    const ERpct = impressions>0 ? (likes+rts+quotes)/impressions*100 : 0;
    const EngObs = Math.max(ENG, (ERpct/100)*impressions);
    const ER_cap = 0.01 + 0.04*SRM;
    const EffEng = Math.min(EngObs, impressions*ER_cap);
    const Clamp = EngObs>0 ? EffEng/EngObs : 0;
    const SENG = Math.min(sengIn, 0.5*EffEng);
    const QE = Math.min(Math.log(1 + impressions/Math.max(g.followers,1)), 2.0) * SRM;
    const IMP = Math.sqrt(impressions);
    const erMult = Math.min(0.90 + 2*Math.min(ERpct/100, 0.05), 1.0);
    const engageBlock = (((ENG*0.7)*Clamp) + (SENG*150)) * Math.pow(SRM, 1.5);
    const baseScore = (g.SF*500) + (IMP*10) + engageBlock + (QE*120);
    let finalScore = baseScore * erMult * g.postMult;

    const ERobs = impressions>0 ? (EngObs/impressions)*100 : 0;
    let statusTxt = I18N[LANG].statusOK; let eligible = true; let penalized=false; let dq=false;
    if(ERobs > 20){ finalScore=0; statusTxt = I18N[LANG].statusDQ; eligible=false; dq=true; }
    if(ERpct > 10 && impressions < 50000){ finalScore *= 0.30; statusTxt = statusTxt===I18N[LANG].statusOK? I18N[LANG].statusPenalty : statusTxt + ' + ' + I18N[LANG].statusPenalty; penalized=true; }
    if(g.posts < 2 || impressions <= 0){ eligible=false; statusTxt = statusTxt===I18N[LANG].statusOK? I18N[LANG].statusIneligible : statusTxt + ' + ' + I18N[LANG].statusIneligible; }

    row.querySelector('[data-erpct]').textContent = ERpct ? ERpct.toFixed(2) : '0.00';
    row.querySelector('[data-srm]').textContent = SRM.toFixed(3);
    row.querySelector('[data-score]').textContent = fmt(finalScore, 2);
    const badge = row.querySelector('[data-status]');
    badge.textContent = statusTxt; badge.className = 'pill ' + (dq ? 'bad' : (statusTxt!==I18N[LANG].statusOK ? 'warn' : 'good'));

    const likeShare = ENG>0 ? likes/ENG : 0;
    const spreadShare = ENG>0 ? (3*rts + qW*quotes)/ENG : 0;

    return { finalScore, eligible, impressions, ERpct, SRM, SENG, EffEng, likeShare, spreadShare, QE, penalized, dq };
  }

  function recalc(){
    const g = globals();
    let sumScore = 0, totalScore = 0, rows=0, totImpr=0, sumER=0, sumSRM=0, sumLikeShare=0, sumSpreadShare=0, penalizedCount=0, dqCount=0;
    $('#linksTable tbody').querySelectorAll('tr').forEach(row=>{
      const r = computeRow(row, g); rows++;
      totalScore += r.finalScore; if(r.eligible) sumScore += r.finalScore;
      totImpr += r.impressions; sumER += r.ERpct; sumSRM += r.SRM; sumLikeShare += r.likeShare; sumSpreadShare += r.spreadShare;
      if(r.penalized) penalizedCount++; if(r.dq) dqCount++;
    });
    $('#sumScore').textContent = fmt(sumScore,2); $('#totalScore').textContent = fmt(totalScore,2); $('#statPostsVal').textContent = rows;

    const rank = estimateRank(sumScore); $('#rankVsSS2').textContent = rank<=SS2.n ? `#${rank}/${SS2.n}` : `>${SS2.n}`;
    const t = I18N[LANG];
    $('#ss2stats').innerHTML = `${t.youScore}: <b class=mono>${fmt(sumScore,2)}</b>`;
  }

  function estimateRank(score){
    if(score<=0) return SS2.n+1;
    const anchors = [ [SS2.p500,500], [SS2.p300,300], [SS2.p200,200], [SS2.p100,100] ].sort((a,b)=>a[0]-b[0]);
    if(score <= anchors[0][0]){ const a=0, b=1; const r = anchors[a][1] + (anchors[b][1]-anchors[a][1]) * ((anchors[0][0]-score)/Math.max(anchors[0][0]-0,1)); return Math.round(Math.min(SS2.n, Math.max(1,r))); }
    for(let i=0;i<anchors.length-1;i++){
      const [s1,r1] = anchors[i]; const [s2,r2]=anchors[i+1]; if(score>=s1 && score<=s2){ const t = (score-s1)/(s2-s1); const r = r1 + (r2-r1)*t; return Math.round(r); }
    }
    const sTop = anchors[anchors.length-1][0]; if(score >= sTop){ const extra = Math.max(0, (score - sTop)/sTop); const r = 100 - Math.min(60, Math.sqrt(extra)*60); return Math.max(1, Math.round(r)); }
    return SS2.n+1;
  }

  // cấu hình oauth đã tích hợp phần 2
  const OAUTH = {
    authorizeBase:'https://twitter.com/i/oauth2/authorize',
    tokenProxy:'https://zama-oauth-proxy.doanlonghau.workers.dev',
    clientId:'wyrAuFlOTIDeC3RpbYWPXgtMc', // thay bằng OAuth 2.0 Client ID nếu khác
    redirectUri:'https://zama-calculator-rho.vercel.app/'
  };
  const OAUTH_SCOPES = ['tweet.read','users.read','offline.access'];

  function b64url(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
  async function sha256(str){ const enc = new TextEncoder().encode(str); return await crypto.subtle.digest('SHA-256', enc); }
  function rnd(n=32){ const a = new Uint8Array(n); crypto.getRandomValues(a); return b64url(a); }

  let X_ACCESS_TOKEN=null, X_REFRESH_TOKEN=null, X_HANDLE=null, X_NEXT_TOKEN=null;

  async function xStartLogin(){
    $('#xAuthStatus').textContent = I18N[LANG].xAuthBusy;
    const verifier = rnd(48); const challenge = b64url(await sha256(verifier)); const state=rnd(24);
    sessionStorage.setItem('x_pkce_verifier', verifier); sessionStorage.setItem('x_pkce_state', state);
    const p = new URLSearchParams({
      response_type:'code',
      client_id:OAUTH.clientId,
      redirect_uri:OAUTH.redirectUri,
      scope:OAUTH_SCOPES.join(' '),
      state,
      code_challenge:challenge,
      code_challenge_method:'S256'
    });
    location.href = `${OAUTH.authorizeBase}?${p.toString()}`;
  }

  async function xHandleCallback(){
    const url = new URL(location.href);
    const code=url.searchParams.get('code');
    const state=url.searchParams.get('state');
    if(!code) return;

    const expect = sessionStorage.getItem('x_pkce_state');
    const verifier = sessionStorage.getItem('x_pkce_verifier');
    if(!state || state!==expect){
      $('#xAuthStatus').textContent = I18N[LANG].xAuthFail;
      history.replaceState({}, document.title, location.pathname);
      return;
    }
    try{
      const r = await fetch(OAUTH.tokenProxy, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, code_verifier:verifier, redirect_uri:OAUTH.redirectUri })
      });
      if(!r.ok){
        $('#xAuthStatus').textContent = I18N[LANG].xAuthFail;
        history.replaceState({}, document.title, location.pathname);
        return;
      }
      const tok = await r.json();
      X_ACCESS_TOKEN = tok.access_token||null;
      X_REFRESH_TOKEN = tok.refresh_token||null;

      const me = await fetch('https://api.twitter.com/2/users/me?user.fields=username', {
        headers:{ Authorization:`Bearer ${X_ACCESS_TOKEN}` }
      });
      if(me.ok){
        const js = await me.json();
        X_HANDLE = '@' + (js.data?.username||'x');
        $('#xAuthStatus').textContent = I18N[LANG].xAuthOk(X_HANDLE);
        $('#xLoginBtn').style.display='none';
        $('#xLogoutBtn').style.display='';
        $('#xFetchBtn').disabled=false;
      }else{
        $('#xAuthStatus').textContent = I18N[LANG].xAuthFail;
      }
    }catch(e){
      $('#xAuthStatus').textContent = I18N[LANG].xAuthFail;
    }
    history.replaceState({}, document.title, location.pathname);
  }

  function xLogout(){
    X_ACCESS_TOKEN=null; X_REFRESH_TOKEN=null; X_HANDLE=null;
    $('#xAuthStatus').textContent=I18N[LANG].xAuthReady;
    $('#xLoginBtn').style.display=''; $('#xLogoutBtn').style.display='none';
    $('#xFetchBtn').disabled=true; $('#xMoreBtn').disabled=true;
  }

  async function xFetch(query, nextToken){
    const estERInput = $('#xEstimate');
    const estER = estERInput ? Math.max(0.1, +estERInput.value || 2.5) : 2.5;
    const status=$('#xApiStatus');
    if(!X_ACCESS_TOKEN){ if(status) status.textContent = I18N[LANG].xAuthReady; return; }
    const params = new URLSearchParams({
      query,
      'tweet.fields':'public_metrics,created_at,entities',
      expansions:'author_id',
      'user.fields':'username,public_metrics',
      max_results:'50'
    });
    if(nextToken) params.set('next_token', nextToken);
    try{
      const resp = await fetch('https://api.twitter.com/2/tweets/search/recent?' + params.toString(), {
        headers:{ Authorization:`Bearer ${X_ACCESS_TOKEN}` }
      });
      if(!resp.ok){ return; }
      const data = await resp.json();
      const usersById = new Map((data.includes?.users||[]).map(u=>[u.id,u]));
      const items = (data.data||[]).map(tw=>{
        const u=usersById.get(tw.author_id);
        const username=u?.username||'x';
        const url=`https://x.com/${username}/status/${tw.id}`;
        const pm=tw.public_metrics||{};
        const likes=pm.like_count||0, retweets=pm.retweet_count||0, quotes=pm.quote_count||0;
        const engagements = likes+retweets+quotes;
        const impressions = engagements>0 ? Math.round(engagements/(estER/100)) : 0;
        return { url, impressions, likes, retweets, quotes };
      });
      if(items.length) rowsFromObjects(items);
      X_NEXT_TOKEN = data.meta?.next_token||null;
      $('#xMoreBtn').disabled = !X_NEXT_TOKEN;
    }catch(e){ }
  }

  $('#xLoginBtn').addEventListener('click', xStartLogin);
  $('#xLogoutBtn').addEventListener('click', xLogout);
  $('#xFetchBtn').addEventListener('click', ()=>{ X_NEXT_TOKEN=null; xFetch('(@zama_fhe OR #ZamaCreatorProgram) -is:reply', null); });
  $('#xMoreBtn').addEventListener('click', ()=>{ if(X_NEXT_TOKEN) xFetch('(@zama_fhe OR #ZamaCreatorProgram) -is:reply', X_NEXT_TOKEN); });

  renderStatic(); buildThead(); addRow(); recalc(); xHandleCallback();
</script>
</body>
</html>
